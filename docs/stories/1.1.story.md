# Story 1.1: User Registration & Login

**Epic:** Epic 1 - Authentication & User Management
**Status:** Approved
**Priority:** P0 (Blocker for MVP)
**Created:** 2026-02-05
**Approved:** 2026-02-05

---

## Story

**As a** corretor imobiliÃ¡rio (real estate agent),
**I want** to create an account and securely log in to the system,
**so that** I can access the ImobCurator platform and manage my clients and properties.

---

## Acceptance Criteria

1. [ ] User can register with email and password
2. [ ] Email validation (valid email format required)
3. [ ] Password must have minimum 8 characters
4. [ ] Password is hashed with bcrypt (cost 12)
5. [ ] Login returns JWT token (access + refresh)
6. [ ] Access token expires in 15 minutes
7. [ ] Refresh token expires in 7 days
8. [ ] Rate limiting: Maximum 5 login attempts per 15 minutes per IP
9. [ ] Registration creates user record in database with all required fields
10. [ ] Login validates credentials and returns user profile data
11. [ ] Error messages are user-friendly and secure (don't leak information)
12. [ ] Frontend stores tokens securely and includes them in authenticated requests

---

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled
>
> CodeRabbit CLI is not enabled in `core-config.yaml`.
> Quality validation will use manual review process only.
> To enable, set `coderabbit_integration.enabled: true` in core-config.yaml

---

## Tasks / Subtasks

### Backend Implementation

- [ ] **Task 1: Database Schema & Migrations** (AC: 1, 9)
  - [ ] Create Prisma schema for `users` table with all required fields
  - [ ] Include fields: id (UUID), email (unique), password_hash, name, phone, agency, license_number, avatar_url
  - [ ] Add preference fields: language (default 'pt-PT'), timezone, currency, theme
  - [ ] Add metadata fields: created_at, updated_at, last_login
  - [ ] Create initial migration
  - [ ] Test migration in development environment

- [ ] **Task 2: Authentication Routes** (AC: 1, 5, 8)
  - [ ] Create `api/src/routes/auth.routes.ts` with POST /api/auth/register endpoint
  - [ ] Create POST /api/auth/login endpoint
  - [ ] Create POST /api/auth/refresh endpoint for refreshing access tokens
  - [ ] Create POST /api/auth/logout endpoint
  - [ ] Implement rate limiting middleware (5 attempts per 15 min)
  - [ ] Add validation middleware using Zod schemas

- [ ] **Task 3: Authentication Controller** (AC: 1, 4, 5, 6, 7, 10, 11)
  - [ ] Implement register controller:
    - Validate email format and uniqueness
    - Validate password strength (min 8 chars)
    - Hash password with bcrypt (cost 12)
    - Create user record in database
    - Return success response (do not return password hash)
  - [ ] Implement login controller:
    - Validate credentials
    - Compare password with bcrypt
    - Generate JWT access token (15 min expiry)
    - Generate JWT refresh token (7 days expiry)
    - Update last_login timestamp
    - Return tokens and user profile
  - [ ] Implement refresh token controller
  - [ ] Implement logout controller
  - [ ] Add error handling with user-friendly messages

- [ ] **Task 4: JWT Utilities** (AC: 5, 6, 7)
  - [ ] Create `api/src/utils/jwt.utils.ts`
  - [ ] Implement generateAccessToken() with 15 min expiry
  - [ ] Implement generateRefreshToken() with 7 days expiry
  - [ ] Implement verifyToken() function
  - [ ] Use strong JWT secret from environment variables
  - [ ] Add token payload: userId, email, role

- [ ] **Task 5: Authentication Middleware** (AC: 12)
  - [ ] Create `api/src/middleware/auth.middleware.ts`
  - [ ] Implement authenticateToken middleware to protect routes
  - [ ] Extract token from Authorization header (Bearer token)
  - [ ] Verify token and attach user to request object
  - [ ] Handle expired tokens with appropriate error
  - [ ] Handle invalid tokens with appropriate error

- [ ] **Task 6: Validation Schemas** (AC: 2, 3)
  - [ ] Create Zod schema for registration: email (valid format), password (min 8 chars), name (required)
  - [ ] Create Zod schema for login: email, password
  - [ ] Add validation middleware to routes
  - [ ] Return validation errors in user-friendly format

### Frontend Implementation

- [ ] **Task 7: API Client Setup** (AC: 12)
  - [ ] Create `web/src/services/api/client.ts` with axios instance
  - [ ] Configure base URL from environment variables
  - [ ] Add request interceptor to attach access token to headers
  - [ ] Add response interceptor to handle 401 errors and refresh tokens
  - [ ] Implement token refresh logic when access token expires

- [ ] **Task 8: Authentication Service** (AC: 1, 5, 10)
  - [ ] Create `web/src/services/api/auth.ts`
  - [ ] Implement register(email, password, name) function
  - [ ] Implement login(email, password) function
  - [ ] Implement logout() function
  - [ ] Implement refreshToken() function
  - [ ] Handle API errors and return user-friendly messages

- [ ] **Task 9: Auth Context & Hook** (AC: 10, 12)
  - [ ] Create `web/src/contexts/AuthContext.tsx`
  - [ ] Manage auth state: user, isAuthenticated, isLoading
  - [ ] Store tokens in memory (not localStorage for security)
  - [ ] Provide login, register, logout functions
  - [ ] Create `web/src/hooks/useAuth.ts` custom hook
  - [ ] Load user on app initialization if refresh token exists

- [ ] **Task 10: Registration Page** (AC: 1, 2, 3, 11)
  - [ ] Create `web/src/pages/Register.tsx`
  - [ ] Form fields: Email, Password, Confirm Password, Name
  - [ ] Client-side validation: email format, password strength, password match
  - [ ] Show password strength indicator
  - [ ] Submit form to register API
  - [ ] Handle success: redirect to login or auto-login
  - [ ] Handle errors: display user-friendly error messages
  - [ ] Add link to login page for existing users
  - [ ] Make responsive (mobile-first)

- [ ] **Task 11: Login Page** (AC: 5, 10, 11)
  - [ ] Update existing `web/src/pages/Login.tsx` to use real API
  - [ ] Form fields: Email, Password
  - [ ] Submit form to login API
  - [ ] Store tokens securely (in-memory via context)
  - [ ] Handle success: redirect to dashboard
  - [ ] Handle errors: display user-friendly messages (e.g., "Invalid credentials")
  - [ ] Add link to registration page
  - [ ] Add "Forgot Password" link (placeholder for Story 1.3)
  - [ ] Make responsive (mobile-first)

- [ ] **Task 12: Protected Routes** (AC: 12)
  - [ ] Create `web/src/components/ProtectedRoute.tsx` component
  - [ ] Check if user is authenticated
  - [ ] Redirect to login if not authenticated
  - [ ] Apply to all protected routes (Dashboard, Clients, Properties, etc.)
  - [ ] Show loading state while checking authentication

### Testing

- [ ] **Task 13: Backend Unit Tests**
  - [ ] Test register controller: success, duplicate email, invalid email, weak password
  - [ ] Test login controller: success, invalid credentials, wrong password
  - [ ] Test JWT generation and verification
  - [ ] Test password hashing and comparison
  - [ ] Test rate limiting middleware

- [ ] **Task 14: Frontend Unit Tests**
  - [ ] Test AuthContext state management
  - [ ] Test useAuth hook
  - [ ] Test API client token interceptors
  - [ ] Test registration form validation
  - [ ] Test login form validation

- [ ] **Task 15: Integration Tests**
  - [ ] Test complete registration flow (E2E)
  - [ ] Test complete login flow (E2E)
  - [ ] Test token refresh flow
  - [ ] Test protected route access
  - [ ] Test logout flow

---

## Dev Notes

### Architecture Context

**Source:** [docs/architecture.md]

**Current State:**
- Frontend has mock authentication using localStorage
- No backend API exists yet
- Login page exists at `web/src/pages/Login.tsx` (needs to be updated)

**Target Architecture:**
- Three-tier architecture: Frontend â†’ API â†’ Database
- RESTful API with JWT authentication
- PostgreSQL database with Prisma ORM
- Tokens stored in-memory (frontend) for security

### Tech Stack

**Backend:**
- Node.js 20+ LTS
- Express or Fastify (recommend Express for team familiarity)
- TypeScript 5.8+
- Prisma ORM (latest)
- bcrypt for password hashing
- jsonwebtoken for JWT
- Zod for validation

**Frontend (Existing):**
- React 19.2.3
- TypeScript 5.8.2
- Vite 6.2.0
- React Router 7.13.0
- Tailwind CSS (styling)

**Database:**
- PostgreSQL (primary database)
- Recommendation: Use Supabase for managed PostgreSQL + authentication helpers

### Database Schema

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  phone VARCHAR(20),
  agency VARCHAR(255),
  license_number VARCHAR(100),
  avatar_url TEXT,

  -- Preferences
  language VARCHAR(5) DEFAULT 'pt-PT',
  timezone VARCHAR(50) DEFAULT 'Europe/Lisbon',
  currency VARCHAR(3) DEFAULT 'EUR',
  theme VARCHAR(10) DEFAULT 'light',

  -- Metadata
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
```

### API Endpoints

```
POST /api/auth/register
  Body: { email, password, name, phone? }
  Returns: { message, user: { id, email, name } }

POST /api/auth/login
  Body: { email, password }
  Returns: {
    accessToken,
    refreshToken,
    user: { id, email, name, ... }
  }

POST /api/auth/refresh
  Body: { refreshToken }
  Returns: { accessToken }

POST /api/auth/logout
  Headers: Authorization: Bearer {accessToken}
  Returns: { message }
```

### Security Requirements

- HTTPS in production (enforce)
- JWT secrets stored in environment variables (never commit to repo)
- Password hashing: bcrypt with cost factor 12
- Rate limiting: Use express-rate-limit middleware (5 attempts per 15 min per IP)
- CORS: Configure to allow only frontend domain
- Input validation: Use Zod schemas on all endpoints
- SQL injection prevention: Prisma ORM parameterized queries
- XSS prevention: Sanitize all user inputs

### File Structure

**Backend (new):**
```
api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ auth.routes.ts
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ auth.controller.ts
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â””â”€â”€ rateLimiter.middleware.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ jwt.utils.ts
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ auth.types.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .env.example
```

**Frontend (updates):**
```
web/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AuthContext.tsx (NEW)
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useAuth.ts (NEW)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â”œâ”€â”€ client.ts (NEW - axios instance)
â”‚   â”‚       â””â”€â”€ auth.ts (NEW)
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Login.tsx (UPDATE - remove mock, use real API)
â”‚   â”‚   â””â”€â”€ Register.tsx (NEW)
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ ProtectedRoute.tsx (NEW)
```

### Environment Variables

**Backend (.env):**
```
DATABASE_URL="postgresql://user:password@localhost:5432/imobcurator"
JWT_SECRET="your-very-long-random-secret-key"
JWT_REFRESH_SECRET="your-refresh-token-secret"
PORT=3001
NODE_ENV=development
CORS_ORIGIN="http://localhost:5173"
```

**Frontend (.env):**
```
VITE_API_URL="http://localhost:3001/api"
```

### Testing

**Testing Strategy:**
- Unit tests for services, utilities, and controllers
- Integration tests for API endpoints
- E2E tests for complete authentication flows

**Testing Tools:**
- Backend: Jest + Supertest
- Frontend: Vitest + React Testing Library
- E2E: Playwright (future)

**Test Coverage Target:** > 80% for authentication code

### Dependencies to Install

**Backend:**
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "@types/express": "^4.17.17",
    "prisma": "^5.0.0",
    "@prisma/client": "^5.0.0",
    "bcrypt": "^5.1.1",
    "@types/bcrypt": "^5.0.0",
    "jsonwebtoken": "^9.0.2",
    "@types/jsonwebtoken": "^9.0.2",
    "zod": "^3.22.0",
    "express-rate-limit": "^7.1.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "jest": "^29.6.0",
    "supertest": "^6.3.3",
    "ts-jest": "^29.1.1"
  }
}
```

**Frontend:**
```json
{
  "dependencies": {
    "axios": "^1.6.0"
  }
}
```

### Notes from Previous Work

- The existing Login.tsx uses mock authentication with localStorage
- Current user state: `{ id: 1, name: 'JoÃ£o Silva', email: 'joao@example.com', role: 'corretor' }`
- Need to migrate from mock to real API without breaking existing flows
- Dashboard and other pages expect `user` object from auth context

### Important Considerations

1. **Token Storage:** Store tokens in-memory (via React context) for better security. Refresh tokens can be stored in httpOnly cookies (backend implementation).

2. **Token Refresh:** Implement automatic token refresh when access token expires (axios interceptor).

3. **CORS:** Backend must allow frontend origin for development and production.

4. **Rate Limiting:** Protect login endpoint from brute force attacks.

5. **Error Handling:** Never leak sensitive information in error messages (e.g., don't say "Email exists", say "Registration failed").

6. **Migrations:** Test Prisma migrations thoroughly in development before applying to production.

7. **Backward Compatibility:** Existing frontend expects certain user object structure - maintain compatibility.

---

## Testing

### Test Coverage Requirements

- **Unit Tests:** > 80% coverage for authentication services and controllers
- **Integration Tests:** All API endpoints must have integration tests
- **E2E Tests:** Registration flow, login flow, protected route access

### Test Files to Create

**Backend:**
- `api/src/controllers/__tests__/auth.controller.test.ts`
- `api/src/utils/__tests__/jwt.utils.test.ts`
- `api/src/middleware/__tests__/auth.middleware.test.ts`

**Frontend:**
- `web/src/contexts/__tests__/AuthContext.test.tsx`
- `web/src/hooks/__tests__/useAuth.test.ts`
- `web/src/pages/__tests__/Login.test.tsx`
- `web/src/pages/__tests__/Register.test.tsx`

### Testing Frameworks

- **Backend:** Jest + Supertest
- **Frontend:** Vitest + React Testing Library (already configured)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Initial story creation | @aios-master (Orion) |
| 2026-02-05 | 1.1 | Status changed: Draft â†’ Approved | @aios-master (Orion) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent during implementation_

### Debug Log References

_To be filled by dev agent during implementation_

### Completion Notes List

_To be filled by dev agent during implementation_

### File List

_To be filled by dev agent during implementation_

---

## QA Results

_To be filled by QA agent after implementation review_
